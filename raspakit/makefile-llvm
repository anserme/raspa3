CXX=clang++
CXXFLAGS=-O3 -march=native -ffast-math  -std=c++2b -fopenmp -g -Wall -Wextra -Wshadow -Wnon-virtual-dtor -Wold-style-cast -Wcast-align -Wunused -Woverloaded-virtual -Wpedantic -Wconversion -Wsign-conversion -Wnull-dereference -Wdouble-promotion -Wformat=2 -Werror -fomit-frame-pointer -ftree-vectorize -fno-stack-check -funroll-loops -fmodules -fbuiltin-module-map -stdlib=libc++ -fprebuilt-module-path=. -fprebuilt-module-path=../mathkit -fprebuilt-module-path=../foundationkit -fprebuilt-module-path=../symmetrykit

.PHONY: default
default: libraspakit;

.SUFFIXES:
.SUFFIXES: .pcm .ixx *.cpp

.SECONDARY:

%.o: %.cpp %.pcm
	$(CXX) $(CXXFLAGS) -fmodule-file=$(word 2,$^) -c $< -o $@

%.pcm: %.ixx
	$(CXX) $(CXXFLAGS) -x c++-module --precompile $< -o $@
	$(CXX) $(CXXFLAGS) -x c++-module -c $< -o $@.o

isotherm: isotherm.o
pressure_range: pressure_range.o
multi_site_isotherm: isotherm multi_site_isotherm.o
units: units.o
running_energy: running_energy.o
averages: averages.o
simulationbox: units averages simulationbox.o
forcefield: forcefield.o
property_widom: property_widom.o
property_pressure: property_pressure.o
property_simulationbox: property_simulationbox.o
property_lambda_probability_histogram: simulationbox averages property_lambda_probability_histogram.o
property_dudlambda: averages property_dudlambda.o
lambda: property_dudlambda property_lambda_probability_histogram lambda.o
component: multi_site_isotherm atom averages property_widom lambda forcefield component.o
energy_factor: energy_factor.o
force_factor: force_factor.o
energy_status_inter: energy_factor energy_status_inter.o
energy_status_intra: energy_status_intra.o
energy_status: component energy_status_inter energy_status_intra energy_status.o
property_energy: energy_status property_energy.o
loadings: loadings.o
property_loading: loadings property_loading.o
enthalpy_of_adsorption: units averages energy_status enthalpy_of_adsorption.o
property_enthalpy: enthalpy_of_adsorption property_enthalpy.o
atom: atom.o
potential_energy_vdw: energy_factor forcefield potential_energy_vdw.o
potential_gradient_vdw: force_factor forcefield potential_gradient_vdw.o
potential_correction_vdw: energy_factor forcefield potential_correction_vdw.o
potential_energy_coulomb: energy_factor forcefield potential_energy_coulomb.o
potential_gradient_coulomb: force_factor forcefield potential_gradient_coulomb.o
framework: framework.o
cbmc_growing_status: component running_energy cbmc_growing_status.o
cbmc: atom running_energy energy_status cbmc.o
sample_movies: units atom simulationbox forcefield sample_movies.o
system: multi_site_isotherm isotherm pressure_range potential_energy_vdw potential_gradient_vdw potential_energy_coulomb potential_gradient_coulomb cbmc cbmc_growing_status averages property_simulationbox property_energy property_pressure property_loading property_enthalpy enthalpy_of_adsorption loadings simulationbox forcefield sample_movies system.o
system_dependencies: system
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_hardware_info.cpp -o system_hardware_info.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_integration.cpp -o system_integration.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_interactions_framework_molecule.cpp -o system_interactions_framework_molecule.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_interactions_intermolecular.cpp -o system_interactions_intermolecular.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_interactions_ewald.cpp -o system_interactions_ewald.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_interactions_tailcorrection.cpp -o system_interactions_tailcorrection.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_interactions_framework_molecule_pressure.cpp -o system_interactions_framework_molecule_pressure.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_interactions_intermolecular_pressure.cpp -o system_interactions_intermolecular_pressure.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_interactions_ewald_pressure.cpp -o system_interactions_ewald_pressure.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_interactions.cpp -o system_interactions.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_cbmc_rigid.cpp -o system_cbmc_rigid.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_cbmc_rigid_insertion.cpp -o system_cbmc_rigid_insertion.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_cbmc_rigid_deletion.cpp -o system_cbmc_rigid_deletion.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_cbmc_rigid_reinsertion.cpp -o system_cbmc_rigid_reinsertion.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_compute_fluid_properties.cpp -o system_compute_fluid_properties.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_print_enthalpy.cpp -o system_print_enthalpy.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_md_loop.cpp -o system_md_loop.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_print_movestatistics.cpp -o system_print_movestatistics.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_print_energyaverages.cpp -o system_print_energyaverages.o
	$(CXX) $(CXXFLAGS) -fmodule-file=system.pcm -c system_print_pressure_averages.cpp -o system_print_pressure_averages.o
mc_moves: system cbmc mc_moves.o
mc_moves_dependencies: mc_moves
	$(CXX) $(CXXFLAGS) -fmodule-file=mc_moves.pcm -c mc_moves_translation.cpp -o mc_moves_translation.o
	$(CXX) $(CXXFLAGS) -fmodule-file=mc_moves.pcm -c mc_moves_random_translation.cpp -o mc_moves_random_translation.o
	$(CXX) $(CXXFLAGS) -fmodule-file=mc_moves.pcm -c mc_moves_rotation.cpp -o mc_moves_rotation.o
	$(CXX) $(CXXFLAGS) -fmodule-file=mc_moves.pcm -c mc_moves_random_rotation.cpp -o mc_moves_random_rotation.o
	$(CXX) $(CXXFLAGS) -fmodule-file=mc_moves.pcm -c mc_moves_reinsertion.cpp -o mc_moves_reinsertion.o
	$(CXX) $(CXXFLAGS) -fmodule-file=mc_moves.pcm -c mc_moves_insertion.cpp -o mc_moves_insertion.o
	$(CXX) $(CXXFLAGS) -fmodule-file=mc_moves.pcm -c mc_moves_deletion.cpp -o mc_moves_deletion.o
	$(CXX) $(CXXFLAGS) -fmodule-file=mc_moves.pcm -c mc_moves_swap_cfcmc_cbmc.cpp -o mc_moves_swap_cfcmc_cbmc.o
	$(CXX) $(CXXFLAGS) -fmodule-file=mc_moves.pcm -c mc_moves_widom.cpp -o mc_moves_widom.o
	$(CXX) $(CXXFLAGS) -fmodule-file=mc_moves.pcm -c mc_moves_volume.cpp -o mc_moves_volume.o
monte_carlo: property_enthalpy mc_moves_dependencies monte_carlo.o
input_reader: component system input_reader.o
isotherm_fitting: multi_site_isotherm component input_reader isotherm_fitting.o
isotherm_fitting_simulation: isotherm_fitting isotherm_fitting_simulation.o
mixture_prediction: multi_site_isotherm component input_reader mixture_prediction.o
mixture_prediction_simulation: mixture_prediction mixture_prediction_simulation.o
breakthrough: component input_reader mixture_prediction breakthrough.o
breakthrough_simulation: breakthrough input_reader mixture_prediction breakthrough_simulation.o

libraspakit: isotherm pressure_range multi_site_isotherm isotherm_fitting isotherm_fitting_simulation mixture_prediction mixture_prediction_simulation breakthrough breakthrough_simulation units running_energy lambda simulationbox atom averages property_widom property_pressure property_simulationbox property_energy property_loading property_enthalpy property_lambda_probability_histogram property_dudlambda forcefield component framework energy_factor force_factor energy_status energy_status_inter energy_status_intra potential_energy_vdw potential_gradient_vdw potential_correction_vdw potential_energy_coulomb potential_energy_coulomb potential_gradient_coulomb system_dependencies input_reader cbmc cbmc_growing_status mc_moves_dependencies monte_carlo sample_movies loadings enthalpy_of_adsorption 
	ar -rs libraspakit.a isotherm.pcm.o isotherm.o pressure_range.pcm.o pressure_range.o multi_site_isotherm.pcm.o multi_site_isotherm.o isotherm_fitting.pcm.o isotherm_fitting.o isotherm_fitting_simulation.pcm.o isotherm_fitting_simulation.o mixture_prediction.pcm.o mixture_prediction.o mixture_prediction_simulation.pcm.o mixture_prediction_simulation.o breakthrough.pcm.o breakthrough.o breakthrough_simulation.pcm.o breakthrough_simulation.o units.pcm.o units.o running_energy.pcm.o running_energy.o lambda.pcm.o lambda.o simulationbox.pcm.o simulationbox.o atom.pcm.o atom.o averages.pcm.o averages.o property_widom.pcm.o property_widom.o property_pressure.pcm.o property_pressure.o property_simulationbox.pcm.o property_simulationbox.o property_energy.pcm.o property_energy.o property_loading.pcm.o property_loading.o property_enthalpy.pcm.o property_enthalpy.o property_lambda_probability_histogram.pcm.o property_lambda_probability_histogram.o property_dudlambda.pcm.o property_dudlambda.o forcefield.pcm.o forcefield.o component.pcm.o component.o framework.pcm.o framework.o energy_factor.pcm.o energy_factor.o force_factor.pcm.o force_factor.o energy_status.pcm.o energy_status.o energy_status_inter.pcm.o energy_status_inter.o energy_status_intra.pcm.o energy_status_intra.o potential_energy_vdw.pcm.o potential_energy_vdw.o potential_gradient_vdw.pcm.o potential_gradient_vdw.o potential_correction_vdw.pcm.o potential_correction_vdw.o potential_energy_coulomb.pcm.o potential_energy_coulomb.o potential_gradient_coulomb.pcm.o potential_gradient_coulomb.o system.pcm.o system.o system_integration.o system_interactions_framework_molecule.o system_interactions_intermolecular.o system_interactions_ewald.o system_interactions_tailcorrection.o system_interactions_framework_molecule_pressure.o system_interactions_intermolecular_pressure.o system_interactions_ewald_pressure.o system_interactions.o system_cbmc_rigid.o system_cbmc_rigid_insertion.o system_cbmc_rigid_deletion.o system_cbmc_rigid_reinsertion.o system_compute_fluid_properties.o system_hardware_info.o system_integration.o system_md_loop.o system_print_enthalpy.o system_print_movestatistics.o system_print_energyaverages.o system_print_pressure_averages.o input_reader.pcm.o input_reader.o cbmc.pcm.o cbmc.o cbmc_growing_status.pcm.o cbmc_growing_status.o mc_moves.pcm.o mc_moves.o mc_moves_translation.o mc_moves_random_translation.o  mc_moves_rotation.o mc_moves_random_rotation.o mc_moves_reinsertion.o mc_moves_insertion.o mc_moves_deletion.o mc_moves_swap_cfcmc_cbmc.o mc_moves_widom.o mc_moves_volume.o monte_carlo.pcm.o monte_carlo.o sample_movies.pcm.o sample_movies.o loadings.pcm.o loadings.o enthalpy_of_adsorption.pcm.o enthalpy_of_adsorption.o
	ranlib -c libraspakit.a
	rm *.o 

clean:
	rm -f *.pcm *.o *.a 
